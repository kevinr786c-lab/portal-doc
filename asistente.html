<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B Assistant PRO | Violet Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap');
        :root { --primario: #ddd6fe; --acentos: #f5f3ff; --fondo: #fbfaff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--fondo); color: #1e293b; overflow-x: hidden; }
        .glass-panel { background: white; border: 1px solid #ede9fe; border-radius: 2.5rem; box-shadow: 0 10px 40px rgba(139, 92, 246, 0.08); }
        .input-pure { background: #f5f3ff; border: 2px solid transparent; border-radius: 1.2rem; padding: 14px 18px; width: 100%; outline: none; transition: 0.3s; font-size: 0.9rem; }
        .input-pure:focus { border-color: #c4b5fd; background: white; }
        .capsule-menu { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid #ddd6fe; padding: 12px 30px; border-radius: 100px; display: flex; gap: 25px; align-items: center; box-shadow: 0 20px 50px rgba(139, 92, 246, 0.15); z-index: 1000; }
        .nav-icon { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; cursor: pointer; font-size: 1.2rem; }
        .nav-icon.active { background: #ede9fe; color: #7c3aed; }
        .lock-screen { backdrop-filter: blur(25px); background: rgba(255,255,255,0.9); z-index: 9999; }
        .btn-action { transition: 0.2s; }
        .btn-action:hover { transform: scale(1.05); }
    </style>
</head>
<body class="p-4 md:p-12 text-left">

    <div id="pantalla-bloqueo" class="fixed inset-0 lock-screen flex items-center justify-center">
        <div class="text-center p-10 bg-white rounded-[3rem] shadow-2xl border border-violet-100">
            <span class="text-5xl mb-4 block">üíú</span>
            <h2 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-widest text-center">Login Asistente</h2>
            <input type="password" id="pin-acceso" class="w-full p-4 rounded-2xl bg-violet-50 text-center text-2xl tracking-[1em] mb-4 outline-none border-none" placeholder="****">
            <button onclick="verificarAcceso()" class="w-full py-4 bg-violet-600 text-white rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-violet-700 transition-all text-center text-center">Entrar</button>
        </div>
    </div>

    <div id="contenido-panel" class="hidden opacity-0 transition-opacity duration-700">
        <header class="max-w-7xl mx-auto flex justify-between items-start mb-10 text-left">
            <div>
                <h1 class="text-4xl font-black text-slate-800 tracking-tight italic">K.B <span class="text-purple-400">Assistant</span></h1>
                <p id="live-date" class="text-slate-400 font-medium mt-1 uppercase text-[10px] tracking-widest text-left"></p>
            </div>
            <div class="flex items-center gap-3">
                <span class="px-4 py-2 bg-violet-50 text-violet-500 rounded-full text-[9px] font-black uppercase border border-violet-100 animate-pulse text-left">Live Sync Active</span>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 pb-32 text-left">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-8 border-t-8 border-violet-400">
                    <h3 class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-6 italic text-left">Control de Turno</h3>
                    <div class="mb-8">
                        <p class="text-3xl font-extrabold text-slate-700 leading-tight" id="patient-display">Seleccione Paciente</p>
                        <p id="patient-phone-display" class="text-[10px] font-bold text-slate-400 uppercase mt-1">Sin datos de contacto</p>
                        <div id="patient-extra-info" class="mt-4 p-4 bg-violet-50 rounded-2xl hidden text-left">
                            <p class="text-[9px] font-black text-violet-400 uppercase">Hora Programada:</p>
                            <p id="patient-hour-display" class="text-lg font-bold text-violet-700 mb-2">--:--</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 mb-6">
                        <button onclick="contactarWhatsApp()" class="flex-1 py-3 bg-emerald-100 text-emerald-600 rounded-xl font-bold text-[10px] uppercase btn-action text-center">WhatsApp</button>
                        <button onclick="llamarPaciente()" class="flex-1 py-3 bg-blue-100 text-blue-600 rounded-xl font-bold text-[10px] uppercase btn-action text-center">Llamar</button>
                    </div>

                    <button onclick="prepararCobro()" class="w-full py-4 bg-violet-50 text-violet-600 rounded-2xl font-black text-[10px] uppercase tracking-widest border border-violet-100 hover:bg-violet-500 hover:text-white transition-all text-center">
                        üí∞ Finalizar y Cobrar
                    </button>
                </div>

                <div class="glass-panel p-8 bg-violet-50/30">
                    <h3 class="text-[9px] font-black uppercase text-slate-400 mb-4 italic text-left">Notas y Respuesta Dra.</h3>
                    <div class="space-y-3">
                        <div class="p-4 bg-white rounded-2xl border border-violet-100">
                            <p class="text-[8px] font-black text-violet-300 uppercase mb-1">Nota Enviada:</p>
                            <p id="patient-note-display" class="text-xs font-medium text-slate-600 italic">--</p>
                        </div>
                        <div class="p-4 bg-violet-100 rounded-2xl border border-violet-200">
                            <p class="text-[8px] font-black text-violet-500 uppercase mb-1">Respuesta de la Dra:</p>
                            <p id="dra-reply-display" class="text-xs font-bold text-violet-800 italic">Esperando respuesta...</p>
                        </div>
                        <input type="text" id="internal-note-input" class="input-pure text-[10px]" placeholder="Escribir nueva nota interna...">
                        <button onclick="enviarNotaInterna()" class="w-full py-2 bg-violet-600 text-white rounded-xl font-bold text-[9px] uppercase text-center">Enviar a Dra.</button>
                    </div>
                </div>

                <div class="glass-panel p-8">
                    <h3 class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-4 italic text-left text-left">Filtrar por Fecha</h3>
                    <input type="date" id="filtro-fecha" onchange="cargarCitasDesdeSupabase()" class="input-pure">
                </div>
            </div>

            <div class="lg:col-span-8 space-y-8">
                <div id="view-agenda" class="glass-panel p-10 min-h-[500px]">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-800 mb-8 text-left">Agenda Activa (Motor K.B)</h3>
                    <div class="overflow-hidden rounded-3xl border border-slate-50">
                        <table class="w-full text-left">
                            <thead class="bg-violet-50 text-[9px] uppercase font-black text-violet-400">
                                <tr><th class="p-5 text-left">Hora</th><th class="p-5 text-left">Paciente</th><th class="p-5 text-left">Estado</th></tr>
                            </thead>
                            <tbody id="tabla-citas-body" class="text-sm font-medium text-slate-600 text-left"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-finance" class="hidden glass-panel p-10">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-800 mb-8 text-left">Finanzas y Facturaci√≥n</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="p-6 bg-violet-50 rounded-[2rem]">
                            <h4 class="text-[9px] font-black uppercase text-violet-400 mb-4 text-left">Registrar Gasto</h4>
                            <input type="text" id="gasto-desc" class="input-pure mb-3" placeholder="Descripci√≥n">
                            <input type="number" id="gasto-monto" class="input-pure mb-3" placeholder="Monto $">
                            <button onclick="registrarGasto()" class="w-full py-3 bg-violet-600 text-white rounded-xl font-bold text-[9px] uppercase text-center">Guardar Gasto</button>
                        </div>
                        <div class="p-6 bg-slate-50 rounded-[2rem] border border-dashed border-slate-200">
                            <h4 class="text-[9px] font-black uppercase text-slate-400 mb-4 text-left">Facturaci√≥n H√≠brida</h4>
                            <p class="text-[10px] text-slate-400 mb-4 italic text-left">Sincronizaci√≥n manual de facturas externas al portal.</p>
                            <button class="w-full py-3 bg-slate-200 text-slate-500 rounded-xl font-bold text-[9px] uppercase cursor-not-allowed text-center">Pr√≥ximamente</button>
                        </div>
                    </div>
                </div>

                <div id="view-history" class="hidden glass-panel p-10 text-left">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-800 mb-8 text-left">Historial de Cobros</h3>
                    <div class="overflow-hidden rounded-3xl border border-slate-50 text-left">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[9px] uppercase font-black text-slate-400">
                                <tr><th class="p-5 text-left text-left">Paciente</th><th class="p-5 text-left text-left">Fecha</th><th class="p-5 text-left text-left">Status</th></tr>
                            </thead>
                            <tbody id="tabla-historial-body" class="text-sm text-slate-400 italic text-left"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-register" class="hidden glass-panel p-10 text-left">
                    <h3 class="text-[10px] font-black uppercase text-slate-800 mb-8 text-left">Confirmar Liquidaci√≥n</h3>
                    <input type="text" id="reg-nombre" class="input-pure mb-4" readonly>
                    <input type="number" id="reg-monto" class="input-pure mb-6" placeholder="800.00">
                    <div class="flex gap-4">
                        <button onclick="procesarCobroFinal()" class="flex-grow py-4 bg-violet-600 text-white rounded-2xl font-bold uppercase text-[10px] tracking-widest text-center">Registrar Pago</button>
                        <button onclick="switchView('agenda')" class="px-8 bg-slate-100 text-slate-400 rounded-2xl font-bold uppercase text-[10px] text-center">Atr√°s</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="capsule-menu">
        <div class="nav-icon active" id="nav-agenda" onclick="switchView('agenda')">üìã</div>
        <div class="nav-icon" id="nav-finance" onclick="switchView('finance')">üí∏</div>
        <div class="nav-icon" id="nav-history" onclick="switchView('history')">üï∞Ô∏è</div>
        <div class="nav-icon" onclick="location.reload()">üîí</div>
    </nav>

    <script>
        const SUPABASE_URL = "https://ypxtceahtjxcdaefskxe.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_C9j37Nup330TMa-jb3QC4A_z7GhzEBM"; 
        let pacienteSeleccionado = null;

        function verificarAcceso() {
            if(document.getElementById('pin-acceso').value === "0000") {
                document.getElementById('pantalla-bloqueo').classList.add('hidden');
                document.getElementById('contenido-panel').classList.remove('hidden');
                setTimeout(() => { document.getElementById('contenido-panel').style.opacity = "1"; }, 50);
                cargarCitasDesdeSupabase();
            } else { alert("PIN Incorrecto"); }
        }

        async function cargarCitasDesdeSupabase() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Citas?select=*&order=id.desc`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const datos = await res.json();
            const fechaFiltro = document.getElementById('filtro-fecha').value;
            let filtrados = fechaFiltro ? datos.filter(c => c.fecha === fechaFiltro) : datos;

            const activos = filtrados.filter(c => c.estado_contacto !== 'Cobrado');
            const historial = filtrados.filter(c => c.estado_contacto === 'Cobrado');

            document.getElementById('tabla-citas-body').innerHTML = activos.map(c => `
                <tr class="border-b border-violet-50 hover:bg-violet-50 transition cursor-pointer" 
                    onclick="seleccionarPaciente('${c.nombre}', '${c.telefono}', ${c.id}, '${c.hora || '--:--'}', '${c.notas || 'Sin notas'}', '${c.respuesta_dra || 'Sin respuesta'}')">
                    <td class="p-5 font-bold text-violet-500 text-left">${c.hora || '--:--'}</td>
                    <td class="p-5 font-bold text-left">${c.nombre}</td>
                    <td class="p-5 text-left"><span class="px-2 py-1 bg-violet-100 text-violet-600 rounded text-[9px] font-black uppercase text-left">ACTIVO</span></td>
                </tr>
            `).join('');

            document.getElementById('tabla-historial-body').innerHTML = historial.map(c => `
                <tr class="border-b border-slate-50 text-left">
                    <td class="p-5 text-left">${c.nombre}</td>
                    <td class="p-5 text-left">${c.fecha}</td>
                    <td class="p-5 text-left text-emerald-500 font-bold text-[9px]">COBRADO</td>
                </tr>
            `).join('');
        }

        function seleccionarPaciente(nombre, tel, id, hora, notas, respuesta) {
            pacienteSeleccionado = { nombre, tel, id, hora, notas };
            document.getElementById('patient-display').innerText = nombre;
            document.getElementById('patient-phone-display').innerText = "üì± " + tel;
            
            document.getElementById('patient-extra-info').classList.remove('hidden');
            document.getElementById('patient-hour-display').innerText = hora;
            document.getElementById('patient-note-display').innerText = notas;
            document.getElementById('dra-reply-display').innerText = respuesta || "Esperando respuesta...";
        }

        async function enviarNotaInterna() {
            const nota = document.getElementById('internal-note-input').value;
            if(!pacienteSeleccionado || !nota) return alert("Seleccione paciente y escriba nota");
            
            await fetch(`${SUPABASE_URL}/rest/v1/Citas?id=eq.${pacienteSeleccionado.id}`, {
                method: 'PATCH',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ notas: nota, respuesta_dra: "Enviado a Dra." })
            });
            alert("Nota enviada a la Dra.");
            document.getElementById('internal-note-input').value = "";
            cargarCitasDesdeSupabase();
        }

        async function registrarGasto() {
            const desc = document.getElementById('gasto-desc').value;
            const monto = document.getElementById('gasto-monto').value;
            if(!desc || !monto) return;
            await fetch(`${SUPABASE_URL}/rest/v1/Gastos`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ descripcion: desc, monto: parseFloat(monto) })
            });
            alert("Gasto registrado");
            document.getElementById('gasto-desc').value = ""; document.getElementById('gasto-monto').value = "";
        }

        async function procesarCobroFinal() {
            const monto = document.getElementById('reg-monto').value;
            await fetch(`${SUPABASE_URL}/rest/v1/Citas?id=eq.${pacienteSeleccionado.id}`, {
                method: 'PATCH',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado_contacto: 'Cobrado' })
            });
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`RECIBO: ${pacienteSeleccionado.nombre} - $${monto}`, 10, 10);
            doc.save(`Ticket_${pacienteSeleccionado.nombre}.pdf`);
            location.reload();
        }

        function switchView(view) {
            document.getElementById('view-agenda').classList.toggle('hidden', view !== 'agenda');
            document.getElementById('view-finance').classList.toggle('hidden', view !== 'finance');
            document.getElementById('view-history').classList.toggle('hidden', view !== 'history');
            document.getElementById('view-register').classList.toggle('hidden', view !== 'register');
            
            document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-' + view)) document.getElementById('nav-' + view).classList.add('active');
        }

        function prepararCobro() {
            if(!pacienteSeleccionado) return alert("Elige un paciente");
            document.getElementById('reg-nombre').value = pacienteSeleccionado.nombre;
            switchView('register');
        }

        function contactarWhatsApp() {
            if(!pacienteSeleccionado) return;
            window.open(`https://wa.me/${pacienteSeleccionado.tel.replace(/\D/g,'')}?text=Hola%20${pacienteSeleccionado.nombre}`);
        }

        function llamarPaciente() {
            if(!pacienteSeleccionado) return;
            window.location.href = `tel:${pacienteSeleccionado.tel}`;
        }

        document.getElementById('live-date').innerText = new Date().toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' });
    </script>
</body>
</html>
