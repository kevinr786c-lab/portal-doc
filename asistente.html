<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B Assistant PRO | Violet Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap');
        :root { --primario: #ddd6fe; --acentos: #f5f3ff; --fondo: #fbfaff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--fondo); color: #1e293b; overflow-x: hidden; }
        .glass-panel { background: white; border: 1px solid #ede9fe; border-radius: 2.5rem; box-shadow: 0 10px 40px rgba(139, 92, 246, 0.08); }
        .input-pure { background: #f5f3ff; border: 2px solid transparent; border-radius: 1.2rem; padding: 14px 18px; width: 100%; outline: none; transition: 0.3s; font-size: 0.9rem; }
        .input-pure:focus { border-color: #c4b5fd; background: white; }
        .capsule-menu { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid #ddd6fe; padding: 12px 30px; border-radius: 100px; display: flex; gap: 25px; align-items: center; box-shadow: 0 20px 50px rgba(139, 92, 246, 0.15); z-index: 1000; }
        .nav-icon { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; cursor: pointer; font-size: 1.2rem; }
        .nav-icon.active { background: #ede9fe; color: #7c3aed; }
        .btn-violet { background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); color: #5b21b6; font-weight: 800; border-radius: 1.2rem; padding: 16px; transition: 0.4s; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
        .lock-screen { backdrop-filter: blur(20px); background: rgba(255,255,255,0.9); z-index: 9999; }
    </style>
</head>
<body class="p-4 md:p-12">

    <div id="pantalla-bloqueo" class="fixed inset-0 lock-screen flex items-center justify-center">
        <div class="text-center p-10 bg-white rounded-[3rem] shadow-2xl border border-violet-100">
            <span class="text-5xl mb-4 block">ðŸ’œ</span>
            <h2 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-widest">Login Asistente K.B</h2>
            <input type="password" id="pin-acceso" class="w-full p-4 rounded-2xl bg-violet-50 text-center text-2xl tracking-[1em] mb-4 outline-none border-none" placeholder="****">
            <button onclick="verificarAcceso()" class="w-full py-4 bg-violet-600 text-white rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-violet-700 transition-all">Entrar al Sistema</button>
        </div>
    </div>

    <div id="contenido-panel" class="hidden opacity-0 transition-opacity duration-700">
        <header class="max-w-7xl mx-auto flex justify-between items-start mb-10">
            <div>
                <h1 class="text-4xl font-black text-slate-800 tracking-tight italic">K.B <span class="text-violet-400">Assistant PRO</span></h1>
                <p id="live-date" class="text-slate-400 font-medium mt-1 uppercase text-[10px] tracking-widest"></p>
            </div>
            <span class="px-4 py-2 bg-violet-50 text-violet-500 rounded-full text-[9px] font-black uppercase border border-violet-100">Control Financiero</span>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 pb-32">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-8 border-t-8 border-violet-400">
                    <h3 class="text-[9px] font-black uppercase text-slate-400 mb-6 italic">Paciente en Turno</h3>
                    <div class="mb-8">
                        <p class="text-3xl font-extrabold text-slate-700 leading-tight" id="patient-display">Seleccione...</p>
                        <p id="patient-phone-display" class="text-[10px] font-bold text-violet-400 uppercase mt-1">Esperando selecciÃ³n</p>
                    </div>
                    <button onclick="prepararCobro()" class="btn-violet">Finalizar y Cobrar</button>
                </div>

                <div class="glass-panel p-8 bg-violet-50/30">
                    <h3 class="text-[9px] font-black uppercase text-slate-400 mb-4 italic">Registrar Gasto (Salida)</h3>
                    <input type="text" id="gasto-desc" class="input-pure mb-3" placeholder="DescripciÃ³n (Ej: PapelerÃ­a)">
                    <input type="number" id="gasto-monto" class="input-pure mb-3" placeholder="Monto $">
                    <button onclick="registrarGasto()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-[9px] uppercase tracking-widest">Guardar Gasto</button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="view-agenda" class="glass-panel p-10 min-h-[500px]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-[10px] font-black uppercase text-slate-800 tracking-widest">Agenda Activa</h3>
                        <input type="date" id="filtro-fecha" onchange="cargarCitasDesdeSupabase()" class="bg-violet-50 px-4 py-1 rounded-full text-[10px] font-bold text-violet-600 outline-none border-none">
                    </div>
                    <div class="overflow-hidden rounded-3xl">
                        <table class="w-full text-left">
                            <thead class="bg-violet-50/50 text-[9px] uppercase font-black text-violet-400">
                                <tr><th class="p-5">Paciente</th><th class="p-5">Contacto</th><th class="p-5">Status</th></tr>
                            </thead>
                            <tbody id="tabla-citas-body" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-register" class="hidden glass-panel p-10">
                    <h2 class="text-xl font-black mb-6 italic">Generar Comprobante</h2>
                    <input type="text" id="reg-nombre" class="input-pure mb-4" readonly>
                    <input type="number" id="reg-monto" class="input-pure mb-6" placeholder="Monto a cobrar $">
                    <div class="flex gap-4">
                        <button onclick="procesarCobroFinal()" class="btn-violet flex-grow">Confirmar y PDF</button>
                        <button onclick="switchView('agenda')" class="px-8 font-bold text-[10px] uppercase text-slate-400">Cancelar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="capsule-menu">
        <div class="nav-icon active" id="nav-agenda" onclick="switchView('agenda')">ðŸ“‹</div>
        <div class="nav-icon" onclick="location.reload()">ðŸ”’</div>
    </nav>

    <script>
        const SUPABASE_URL = "https://ypxtceahtjxcdaefskxe.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_C9j37Nup330TMa-jb3QC4A_z7GhzEBM"; 

        let pacienteSeleccionado = null;

        function verificarAcceso() {
            const pin = document.getElementById('pin-acceso').value;
            if(pin === "0000") { 
                document.getElementById('pantalla-bloqueo').classList.add('hidden');
                document.getElementById('contenido-panel').classList.remove('hidden');
                setTimeout(() => { document.getElementById('contenido-panel').style.opacity = "1"; }, 50);
                cargarCitasDesdeSupabase();
            } else { alert("PIN Incorrecto"); }
        }

        async function cargarCitasDesdeSupabase() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Citas?select=*&order=id.desc`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const datos = await res.json();
            const activos = datos.filter(c => c.estado_contacto !== 'Cobrado');
            const tbody = document.getElementById('tabla-citas-body');
            tbody.innerHTML = activos.map(c => `
                <tr class="border-b border-violet-50 hover:bg-violet-50/50 cursor-pointer transition" onclick="seleccionarPaciente('${c.nombre}', '${c.telefono}', ${c.id})">
                    <td class="p-5 font-bold text-slate-700">${c.nombre}</td>
                    <td class="p-5 text-slate-400">${c.telefono}</td>
                    <td class="p-5"><span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-lg text-[9px] font-black uppercase">En Espera</span></td>
                </tr>
            `).join('');
        }

        function seleccionarPaciente(nombre, tel, id) {
            pacienteSeleccionado = { nombre, tel, id };
            document.getElementById('patient-display').innerText = nombre;
            document.getElementById('patient-phone-display').innerText = "ðŸ“± " + tel;
        }

        function switchView(view) {
            document.getElementById('view-agenda').classList.toggle('hidden', view !== 'agenda');
            document.getElementById('view-register').classList.toggle('hidden', view !== 'register');
        }

        function prepararCobro() {
            if(!pacienteSeleccionado) return alert("Selecciona un paciente");
            document.getElementById('reg-nombre').value = pacienteSeleccionado.nombre;
            switchView('register');
        }

        async function registrarGasto() {
            const desc = document.getElementById('gasto-desc').value;
            const monto = document.getElementById('gasto-monto').value;
            if(!desc || !monto) return alert("Llena los campos de gasto");

            await fetch(`${SUPABASE_URL}/rest/v1/Gastos`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ descripcion: desc, monto: parseFloat(monto) })
            });
            alert("Gasto sincronizado con el panel de la Dra.");
            document.getElementById('gasto-desc').value = "";
            document.getElementById('gasto-monto').value = "";
        }

        async function procesarCobroFinal() {
            const monto = document.getElementById('reg-monto').value;
            await fetch(`${SUPABASE_URL}/rest/v1/Citas?id=eq.${pacienteSeleccionado.id}`, {
                method: 'PATCH',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado_contacto: 'Cobrado' })
            });
            alert("Pago registrado y agenda limpia.");
            location.reload();
        }

        const now = new Date();
        document.getElementById('live-date').innerText = now.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' });
    </script>
</body>
</html>
