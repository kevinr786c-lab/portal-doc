<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B Tech Solutions | GestiÃ³n Asistente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap');
        :root { --primario: #d8b4fe; --acentos: #fbcfe8; --fondo: #fcfcfd; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--fondo); color: #1e293b; }
        .glass-panel { background: white; border: 1px solid #f1f5f9; border-radius: 2.5rem; box-shadow: 0 10px 40px rgba(216, 180, 254, 0.1); }
        .input-pure { background: #f8fafc; border: 2px solid transparent; border-radius: 1.2rem; padding: 14px 18px; width: 100%; outline: none; transition: 0.3s; font-size: 0.9rem; }
        .input-pure:focus { border-color: var(--primario); background: white; }
        .capsule-menu { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid #f3f0ff; padding: 12px 30px; border-radius: 100px; display: flex; gap: 25px; align-items: center; box-shadow: 0 20px 50px rgba(216, 180, 254, 0.2); z-index: 1000; }
        .nav-icon { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; cursor: pointer; }
        .nav-icon.active { background: #f3f0ff; color: #a855f7; }
        .btn-premium { background: linear-gradient(135deg, #d8b4fe 0%, #fbcfe8 100%); color: white; font-weight: 800; border-radius: 1.2rem; padding: 16px; transition: 0.4s; width: 100%; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(216, 180, 254, 0.4); }
    </style>
</head>
<body class="p-4 md:p-12">

    <header class="max-w-7xl mx-auto flex justify-between items-start mb-10">
        <div>
            <h1 class="text-4xl font-black text-slate-800 tracking-tight">Panel de <span class="text-purple-400">Asistente</span></h1>
            <p id="live-date" class="text-slate-400 font-medium mt-1 uppercase text-[10px] tracking-widest"></p>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-4 py-2 bg-emerald-50 text-emerald-500 rounded-full text-[9px] font-black uppercase border border-emerald-100">Sync Live</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 pb-32">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel p-8 border-t-8 border-purple-300">
                <h3 class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-6">AtenciÃ³n Actual</h3>
                <div class="mb-8">
                    <p class="text-3xl font-extrabold text-slate-700 leading-tight" id="patient-display">Seleccione Paciente</p>
                    <p class="text-[10px] font-bold text-purple-400 uppercase mt-1 tracking-widest">Estado: Espera</p>
                </div>
                <div class="space-y-3">
                    <button onclick="prepararCobro()" class="w-full py-4 bg-emerald-50 text-emerald-600 rounded-2xl font-black text-[10px] uppercase tracking-widest border border-emerald-100 hover:bg-emerald-500 hover:text-white transition-all">
                        ðŸ’° Finalizar y Cobrar
                    </button>
                    <button onclick="nextPatient()" class="btn-premium">Siguiente Paciente âžœ</button>
                </div>
            </div>

            <div class="glass-panel p-8">
                <h3 class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 mb-4">Notas para la Dra.</h3>
                <textarea id="dr-msg" placeholder="Mensaje interno..." class="input-pure h-28 resize-none"></textarea>
                <button onclick="sendNote()" class="w-full mt-4 py-3 border border-purple-100 text-purple-400 rounded-xl font-bold text-[9px] uppercase tracking-widest">Enviar Aviso</button>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div id="view-agenda" class="glass-panel p-10 min-h-[550px]">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-[9px] font-black uppercase tracking-widest text-slate-400">Agenda del DÃ­a (Sync Motor K.B)</h3>
                    <button onclick="cargarCitasDesdeSupabase()" class="text-[10px] font-black text-purple-400 uppercase">ðŸ”„ Refrescar</button>
                </div>
                <div class="overflow-hidden rounded-3xl border border-slate-50">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[9px] uppercase font-black text-slate-400">
                            <tr><th class="p-5">Paciente</th><th class="p-5">WhatsApp</th><th class="p-5">Fecha</th><th class="p-5">AcciÃ³n</th></tr>
                        </thead>
                        <tbody id="tabla-citas-body" class="text-sm font-medium text-slate-600">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-register" class="hidden glass-panel p-10 animate-fade-in">
                <h3 class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-8">SincronizaciÃ³n de Cobro SAT</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Nombre Completo</label>
                        <input type="text" id="reg-nombre" class="input-pure" placeholder="Nombre del Paciente">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Tipo de Servicio</label>
                        <select id="reg-servicio" class="input-pure">
                            <option value="Consulta Especialidad">Consulta Especialidad</option>
                            <option value="Consulta General">Consulta General</option>
                            <option value="Procedimiento">Procedimiento</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Monto ($)</label>
                        <input type="number" id="reg-monto" class="input-pure" placeholder="0.00">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">RFC Receptor</label>
                        <input type="text" id="reg-rfc" class="input-pure" placeholder="XAXX010101000">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="procesarCobro()" class="btn-premium flex-grow">Registrar & Generar CFDI</button>
                    <button onclick="switchView('agenda')" class="px-8 bg-slate-100 text-slate-400 rounded-2xl font-bold uppercase text-[10px]">AtrÃ¡s</button>
                </div>
            </div>
        </div>
    </main>

    <nav class="capsule-menu">
        <div class="nav-icon active" onclick="switchView('agenda')">ðŸ“…</div>
        <div class="nav-icon" onclick="switchView('register')">ðŸ“„</div>
        <div class="nav-icon" onclick="location.reload()">ðŸ”’</div>
    </nav>

    <script>
        // ðŸ—ï¸ MOTOR CENTRAL K.B SOLUTIONS (Sincronizado)
        const SUPABASE_URL = "https://ypxtceahtjxcdaefskxe.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_C9j37Nup330TMa-jb3QC4A_z7GhzEBM"; 

        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('live-date').innerText = now.toLocaleDateString('es-MX', options);
        }
        setInterval(updateTime, 1000); updateTime();

        function switchView(view) {
            document.getElementById('view-agenda').classList.toggle('hidden', view !== 'agenda');
            document.getElementById('view-register').classList.toggle('hidden', view !== 'register');
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
        }

        // --- ðŸš€ NUEVA FUNCIÃ“N PARA LEER EL MOTOR ---
        async function cargarCitasDesdeSupabase() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Citas?select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                const datos = await res.json();
                const tbody = document.getElementById('tabla-citas-body');
                
                tbody.innerHTML = datos.map(c => `
                    <tr class="border-b border-slate-50 hover:bg-purple-50 transition cursor-pointer" onclick="seleccionarPaciente('${c.nombre}')">
                        <td class="p-5 font-bold">${c.nombre}</td>
                        <td class="p-5">${c.telefono}</td>
                        <td class="p-5">${c.fecha}</td>
                        <td class="p-5"><button class="text-purple-400 text-xs font-black uppercase">Atender</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error("Fallo de motor", e);
            }
        }

        function seleccionarPaciente(nombre) {
            document.getElementById('patient-display').innerText = nombre;
        }

        function prepararCobro() {
            const nombre = document.getElementById('patient-display').innerText;
            if(nombre === "Seleccione Paciente") return alert("Elige un paciente de la lista.");
            document.getElementById('reg-nombre').value = nombre;
            switchView('register');
        }

        async function procesarCobro() {
            const btn = event.target;
            const datos = {
                nombre: document.getElementById('reg-nombre').value,
                monto: document.getElementById('reg-monto').value,
                servicio: document.getElementById('reg-servicio').value,
                rfc: document.getElementById('reg-rfc').value || 'XAXX010101000'
            };

            if(!datos.nombre || !datos.monto) return alert("Datos insuficientes.");
            btn.innerText = "REGISTRANDO..."; btn.disabled = true;

            // AquÃ­ podrÃ­as guardar el pago en una tabla 'Pagos' de Supabase
            // Por ahora, generamos la factura PDF y reseteamos
            generarFacturaSAT(datos);
            alert("OperaciÃ³n Exitosa en Motor K.B");
            location.reload();
        }

        function generarFacturaSAT(datos) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const uuid = Math.random().toString(36).substring(2, 15).toUpperCase();
            
            doc.setFillColor(216, 180, 254); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(20); doc.setFont("helvetica", "bold");
            doc.text("HONORARIOS MÃ‰DICOS", 20, 25);
            doc.setFontSize(8); doc.text("DRA. ALBA PATRICIA | RFC: PATA850101HDFLNA01 | K.B TECH", 20, 33);

            doc.setTextColor(60, 60, 60); doc.setFontSize(10);
            doc.text(`UUID FISCAL: ${uuid}`, 20, 55);
            doc.text(`PACIENTE: ${datos.nombre.toUpperCase()}`, 20, 65);
            doc.text(`RFC RECEPTOR: ${datos.rfc}`, 20, 72);
            doc.setFontSize(14); doc.text(`TOTAL PAGADO: $${datos.monto}.00 MXN`, 20, 90);
            doc.save(`Recibo_K.B_${datos.nombre}.pdf`);
        }

        function nextPatient() { alert("Llamando al siguiente paciente desde el Motor K.B..."); }
        function sendNote() { alert("Aviso enviado al panel de la Dra."); document.getElementById('dr-msg').value = ""; }

        // Cargar citas al iniciar
        cargarCitasDesdeSupabase();
    </script>
</body>
</html>
