<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar Cita | K.B Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        :root { --main: #7c3aed; --bg-soft: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-soft); transition: 0.5s; }
        .glass-card { background: white; border-radius: 2.5rem; border: 1px solid rgba(0,0,0,0.05); }
        .accent-border { border-left: 4px solid var(--main); }
    </style>
</head>
<body class="p-4 md:p-10 text-left">

    <div id="main-container" class="max-w-xl mx-auto glass-card p-8 md:p-12 shadow-2xl text-left hidden opacity-0 transition-opacity duration-700">
        <header class="text-center mb-10">
            <div id="doctor-avatar" class="w-20 h-20 mx-auto bg-slate-100 rounded-full mb-4 flex items-center justify-center text-3xl shadow-inner border-4 border-white">üè•</div>
            <h1 id="doctor-name" class="text-2xl font-black text-slate-800 tracking-tighter italic">Cargando...</h1>
            <p id="doctor-specialty" class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Por favor espere</p>
        </header>

        <form id="form-cita" class="space-y-6 text-left">
            <div class="space-y-2">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Nombre del Paciente</label>
                <input type="text" id="paciente" placeholder="Ej: Juan P√©rez" class="w-full p-4 rounded-2xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-opacity-50 transition" required>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-left">
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Fecha</label>
                    <input type="date" id="fecha" class="w-full p-4 rounded-2xl bg-slate-50 border-none outline-none" required>
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Hora</label>
                    <select id="hora" class="w-full p-4 rounded-2xl bg-slate-50 border-none outline-none" required>
                        <option value="09:00 AM">09:00 AM</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="04:00 PM">04:00 PM</option>
                        <option value="05:00 PM">05:00 PM</option>
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[9px] font-black uppercase text-slate-400 ml-4">Notas para el M√©dico</label>
                <textarea id="notas" placeholder="¬øAlg√∫n s√≠ntoma o duda?" class="w-full p-4 rounded-2xl bg-slate-50 border-none outline-none h-24"></textarea>
            </div>

            <button type="submit" id="btn-submit" class="w-full py-5 text-white rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-xl hover:scale-105 transition-all duration-300">
                Confirmar Cita
            </button>
        </form>
    </div>

    <div id="error-screen" class="hidden max-w-sm mx-auto text-center p-10 bg-white rounded-[3rem] shadow-xl">
        <span class="text-5xl block mb-4">‚ö†Ô∏è</span>
        <h2 class="font-black text-slate-800 uppercase tracking-tighter">Enlace Inv√°lido</h2>
        <p class="text-xs text-slate-400 mt-2">No se encontr√≥ el identificador del m√©dico. Contacte a soporte de K.B Tech.</p>
    </div>

    <script>
        const SUPABASE_URL = "https://ypxtceahtjxcdaefskxe.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_C9j37Nup330TMa-jb3QC4A_z7GhzEBM"; 

        const urlParams = new URLSearchParams(window.location.search);
        const doctorId = urlParams.get('id');

        async function cargarConfiguracionDoctor() {
            if(!doctorId) {
                document.getElementById('error-screen').classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Perfiles_Medicos?id=eq.${doctorId}`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                const data = await res.json();
                
                if(data && data.length > 0) {
                    const doc = data[0];
                    document.getElementById('doctor-name').innerText = doc.nombre_doctor;
                    document.getElementById('doctor-specialty').innerText = doc.especialidad;
                    
                    aplicarTema(doc.template_id);
                    
                    // Mostrar contenedor con animaci√≥n
                    const container = document.getElementById('main-container');
                    container.classList.remove('hidden');
                    setTimeout(() => { container.style.opacity = "1"; }, 50);
                } else {
                    document.getElementById('error-screen').classList.remove('hidden');
                }
            } catch (err) {
                console.error("Error de conexi√≥n:", err);
                document.getElementById('error-screen').classList.remove('hidden');
            }
        }

        function aplicarTema(id) {
            const colors = {
                1: { main: "#7c3aed", bg: "#f5f3ff", ring: "rgba(124, 58, 237, 0.2)" }, // Violeta
                2: { main: "#2563eb", bg: "#eff6ff", ring: "rgba(37, 99, 235, 0.2)" },  // Azul
                3: { main: "#059669", bg: "#ecfdf5", ring: "rgba(5, 150, 105, 0.2)" },  // Verde
                4: { main: "#db2777", bg: "#fff1f2", ring: "rgba(219, 39, 119, 0.2)" }, // Rosa
                5: { main: "#1e293b", bg: "#f8fafc", ring: "rgba(30, 41, 59, 0.2)" }   // Negro
            };
            const theme = colors[id] || colors[1];
            
            document.documentElement.style.setProperty('--main', theme.main);
            document.documentElement.style.setProperty('--bg-soft', theme.bg);
            
            const btn = document.getElementById('btn-submit');
            btn.style.backgroundColor = theme.main;
            btn.style.boxShadow = `0 10px 25px -5px ${theme.ring}`;
            
            document.getElementById('doctor-name').style.color = theme.main;
            document.getElementById('doctor-avatar').style.color = theme.main;
        }

        document.getElementById('form-cita').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            const cita = {
                nombre: document.getElementById('paciente').value,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                notas: document.getElementById('notas').value,
                doctor_id: doctorId 
            };

            await fetch(`${SUPABASE_URL}/rest/v1/Citas`, {
                method: 'POST',
                headers: { 
                    'apikey': SUPABASE_KEY, 
                    'Authorization': `Bearer ${SUPABASE_KEY}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(cita)
            });

            alert(`¬°Cita agendada con √©xito para el paciente ${cita.nombre}!`);
            location.reload();
        });

        cargarConfiguracionDoctor();
    </script>
</body>
</html>
